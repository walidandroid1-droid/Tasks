<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>Budget Ultra Pro</title>
<style>
:root {
  --safe-top: env(safe-area-inset-top, 47px);
  --safe-bottom: env(safe-area-inset-bottom, 34px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  
  --ios-bg: #000000;
  --ios-card: #1c1c1e;
  --ios-card-elevated: #2c2c2e;
  --ios-blue: #0a84ff;
  --ios-green: #30d158;
  --ios-orange: #ff9f0a;
  --ios-red: #ff453a;
  --ios-purple: #bf5af2;
  --ios-teal: #64d2ff;
  --ios-yellow: #ffd60a;
  --ios-pink: #ff375f;
  --ios-indigo: #5e5ce6;
  --ios-gray: #8e8e93;
  --ios-gray2: #636366;
  --ios-gray3: #48484a;
  --ios-gray4: #3a3a3c;
  --ios-gray5: #2c2c2e;
  --ios-gray6: #1c1c1e;
  
  --key-size: min(88px, 22vw);
  --key-gap: 12px;
  --pad-max-width: 400px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

html, body {
  height: 100%;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif;
  background: var(--ios-bg);
  color: white;
}

.app-container {
  height: 100vh;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  padding-left: max(var(--safe-left), 16px);
  padding-right: max(var(--safe-right), 16px);
}

/* Header compact */
.ios-header {
  padding: 8px 0 12px;
  text-align: center;
  flex-shrink: 0;
}

.ios-header-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.3px;
}

.ios-header-subtitle {
  font-size: 13px;
  color: var(--ios-gray);
  margin-top: 2px;
}

/* Main scroll */
.main-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 20px;
}

.main-scroll::-webkit-scrollbar {
  display: none;
}

/* Input Section - Compact */
.input-section {
  background: var(--ios-card);
  border-radius: 24px;
  padding: 16px;
  margin-bottom: 12px;
  border: 0.5px solid rgba(255,255,255,0.1);
}

/* Display Amount */
.amount-display {
  text-align: center;
  padding: 12px 0 16px;
  border-bottom: 0.5px solid var(--ios-gray4);
  margin-bottom: 16px;
}

.amount-label {
  font-size: 13px;
  color: var(--ios-gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.amount-value {
  font-size: 56px;
  font-weight: 300;
  color: white;
  letter-spacing: -2px;
  line-height: 1;
  font-variant-numeric: tabular-nums;
}

.amount-currency {
  font-size: 28px;
  color: var(--ios-gray);
  margin-left: 4px;
}

/* Description Input */
.description-input-container {
  margin-bottom: 16px;
}

.description-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--ios-gray);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.description-input {
  width: 100%;
  height: 48px;
  background: var(--ios-gray6);
  border: 1px solid var(--ios-gray4);
  border-radius: 12px;
  color: white;
  font-size: 17px;
  padding: 0 16px;
  -webkit-appearance: none;
  transition: all 0.2s;
}

.description-input:focus {
  outline: none;
  border-color: var(--ios-blue);
  background: var(--ios-gray5);
}

.description-input::placeholder {
  color: var(--ios-gray2);
}

/* Quick Descriptions Chips */
.quick-descriptions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.desc-chip {
  padding: 6px 12px;
  background: var(--ios-gray5);
  border-radius: 16px;
  font-size: 14px;
  color: var(--ios-gray);
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.desc-chip:active {
  transform: scale(0.95);
  background: var(--ios-gray4);
}

.desc-chip.selected {
  background: var(--ios-blue);
  color: white;
  border-color: rgba(255,255,255,0.2);
}

/* Category Selector */
.category-section {
  margin-bottom: 16px;
}

.category-label {
  font-size: 13px;
  color: var(--ios-gray);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
}

.category-scroll {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 4px 0;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  margin: 0 -4px;
  padding: 4px;
}

.category-scroll::-webkit-scrollbar {
  display: none;
}

.category-chip {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px 16px;
  background: var(--ios-gray5);
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  min-width: 72px;
}

.category-chip:active {
  transform: scale(0.92);
  background: var(--ios-gray4);
}

.category-chip.selected {
  background: var(--ios-blue);
  border-color: rgba(255,255,255,0.3);
  transform: scale(1.02);
}

.category-icon {
  font-size: 28px;
  line-height: 1;
}

.category-name {
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
}

/* ERGONOMIC NUMBER PAD */
.pad-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--key-gap);
  max-width: var(--pad-max-width);
  margin: 0 auto;
  padding: 8px 0;
}

.pad-row {
  display: flex;
  gap: var(--key-gap);
  width: 100%;
  justify-content: center;
}

.num-key {
  width: var(--key-size);
  height: var(--key-size);
  background: var(--ios-gray5);
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 400;
  color: white;
  cursor: pointer;
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  -webkit-appearance: none;
  user-select: none;
}

/* Key press effect */
.num-key:active {
  transform: scale(0.88);
  background: var(--ios-gray4);
}

.num-key::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255,255,255,0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.3s, height 0.3s;
}

.num-key:active::after {
  width: 100%;
  height: 100%;
}

/* Special keys */
.num-key.wide {
  width: calc(var(--key-size) * 2 + var(--key-gap));
  border-radius: 44px;
  background: var(--ios-gray4);
  font-size: 24px;
}

.num-key.action {
  background: var(--ios-blue);
  font-size: 24px;
  font-weight: 600;
}

.num-key.action:active {
  background: #0051d5;
  transform: scale(0.88);
}

.num-key.delete {
  background: var(--ios-gray4);
  font-size: 24px;
}

/* Zero key special */
.num-key.zero {
  position: relative;
}

.num-key.zero::before {
  content: '';
  position: absolute;
  left: calc(var(--key-size) + var(--key-gap));
  width: var(--key-size);
  height: var(--key-size);
  pointer-events: none;
}

/* Add Button */
.add-button {
  width: 100%;
  height: 56px;
  background: var(--ios-green);
  color: white;
  border: none;
  border-radius: 16px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
  -webkit-appearance: none;
}

.add-button:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.add-button:disabled {
  background: var(--ios-gray3);
  color: var(--ios-gray);
  cursor: not-allowed;
}

/* Stats Compact */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}

.stat-item {
  background: var(--ios-card);
  border-radius: 16px;
  padding: 12px 8px;
  text-align: center;
  border: 0.5px solid rgba(255,255,255,0.1);
}

.stat-value {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 2px;
  font-variant-numeric: tabular-nums;
}

.stat-value.positive { color: var(--ios-green); }
.stat-value.negative { color: var(--ios-red); }
.stat-value.neutral { color: white; }

.stat-label {
  font-size: 10px;
  color: var(--ios-gray);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* Calendar Compact */
.calendar-card {
  background: var(--ios-card);
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 12px;
  border: 0.5px solid rgba(255,255,255,0.1);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 0.5px solid var(--ios-gray4);
}

.calendar-title {
  font-size: 17px;
  font-weight: 600;
}

.calendar-nav {
  display: flex;
  gap: 12px;
}

.calendar-btn {
  width: 28px;
  height: 28px;
  background: var(--ios-gray5);
  border-radius: 50%;
  border: none;
  color: white;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  padding: 8px;
  gap: 2px;
}

.cal-day-header {
  text-align: center;
  font-size: 11px;
  color: var(--ios-gray);
  font-weight: 600;
  padding: 6px 0;
}

.cal-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  font-size: 15px;
  position: relative;
  transition: all 0.15s;
  margin: 1px;
}

.cal-day:active {
  transform: scale(0.9);
  background: var(--ios-gray5);
}

.cal-day.today {
  background: var(--ios-blue);
  font-weight: 600;
}

.cal-day.selected {
  box-shadow: 0 0 0 2px var(--ios-blue);
}

.cal-day.has-data {
  font-weight: 600;
}

.cal-dot {
  position: absolute;
  bottom: 3px;
  width: 4px;
  height: 4px;
  border-radius: 50%;
}

/* Recent List */
.recent-card {
  background: var(--ios-card);
  border-radius: 20px;
  overflow: hidden;
  border: 0.5px solid rgba(255,255,255,0.1);
}

.recent-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 0.5px solid var(--ios-gray4);
}

.recent-title {
  font-size: 17px;
  font-weight: 600;
}

.recent-action {
  color: var(--ios-blue);
  font-size: 15px;
  cursor: pointer;
}

.recent-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 0.5px solid var(--ios-gray4);
  cursor: pointer;
  transition: background 0.2s;
}

.recent-item:active {
  background: var(--ios-gray5);
}

.recent-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin-right: 12px;
  flex-shrink: 0;
}

.recent-info {
  flex: 1;
  min-width: 0;
}

.recent-desc {
  font-size: 15px;
  font-weight: 500;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.recent-meta {
  font-size: 13px;
  color: var(--ios-gray);
}

.recent-amount {
  font-size: 16px;
  font-weight: 600;
  color: var(--ios-red);
  font-variant-numeric: tabular-nums;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 32px;
  color: var(--ios-gray);
}

.empty-icon {
  font-size: 40px;
  margin-bottom: 8px;
  opacity: 0.5;
}

/* Tab Bar */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(64px + var(--safe-bottom));
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 0.5px solid rgba(255,255,255,0.15);
  display: flex;
  justify-content: space-around;
  align-items: flex-start;
  padding-top: 8px;
  padding-bottom: var(--safe-bottom);
  z-index: 1000;
}

.tab-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 4px 20px;
  color: var(--ios-gray);
  cursor: pointer;
  transition: color 0.2s;
}

.tab-item.active {
  color: var(--ios-blue);
}

.tab-icon {
  font-size: 24px;
  line-height: 1;
}

.tab-label {
  font-size: 10px;
  font-weight: 500;
}

/* Settings Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 2000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
  display: flex;
  align-items: flex-end;
}

.modal.active {
  opacity: 1;
  visibility: visible;
}

.modal-sheet {
  width: 100%;
  background: var(--ios-card);
  border-radius: 24px 24px 0 0;
  padding: 20px;
  padding-bottom: calc(20px + var(--safe-bottom));
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modal.active .modal-sheet {
  transform: translateY(0);
}

.modal-handle {
  width: 36px;
  height: 5px;
  background: var(--ios-gray3);
  border-radius: 3px;
  margin: 0 auto 20px;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 16px;
}

.input-label {
  display: block;
  font-size: 13px;
  color: var(--ios-gray);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.ios-input {
  width: 100%;
  height: 52px;
  background: var(--ios-gray6);
  border: 1px solid var(--ios-gray4);
  border-radius: 12px;
  color: white;
  font-size: 20px;
  padding: 0 16px;
  font-weight: 500;
  -webkit-appearance: none;
}

.ios-input:focus {
  outline: none;
  border-color: var(--ios-blue);
}

.modal-btn {
  width: 100%;
  height: 52px;
  background: var(--ios-blue);
  color: white;
  border: none;
  border-radius: 14px;
  font-size: 17px;
  font-weight: 600;
  margin-top: 8px;
  cursor: pointer;
  -webkit-appearance: none;
}

.modal-btn.secondary {
  background: var(--ios-gray5);
  color: white;
}

/* Animations */
@keyframes keyPress {
  0% { transform: scale(1); }
  50% { transform: scale(0.88); }
  100% { transform: scale(1); }
}

.key-anim {
  animation: keyPress 0.15s ease;
}

/* Large touch targets for accessibility */
@media (min-width: 390px) {
  :root {
    --key-size: min(92px, 20vw);
    --key-gap: 14px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  
  <!-- Header -->
  <header class="ios-header">
    <h1 class="ios-header-title">üí∞ Budget Ultra</h1>
    <p class="ios-header-subtitle" id="header-date">Aujourd'hui</p>
  </header>

  <main class="main-scroll" id="main-scroll">
    
    <!-- INPUT SECTION -->
    <div class="input-section">
      
      <!-- Amount Display -->
      <div class="amount-display">
        <div class="amount-label">Montant</div>
        <div>
          <span class="amount-value" id="display-amount">0</span>
          <span class="amount-currency">DT</span>
        </div>
      </div>

      <!-- Description Input -->
      <div class="description-input-container">
        <div class="description-label">
          <span>üìù</span> Description (optionnelle)
        </div>
        <input type="text" 
               class="description-input" 
               id="desc-input" 
               placeholder="Ex: Courses hebdo, Essence, etc."
               autocomplete="off">
        
        <!-- Quick Description Chips -->
        <div class="quick-descriptions" id="quick-desc">
          <div class="desc-chip" onclick="setDescription('Courses')">üõí Courses</div>
          <div class="desc-chip" onclick="setDescription('Essence')">‚õΩ Essence</div>
          <div class="desc-chip" onclick="setDescription('Resto')">üçΩÔ∏è Resto</div>
          <div class="desc-chip" onclick="setDescription('Caf√©')">‚òï Caf√©</div>
          <div class="desc-chip" onclick="setDescription('Transport')">üöå Transport</div>
          <div class="desc-chip" onclick="setDescription('Pharmacie')">üíä Pharma</div>
        </div>
      </div>

      <!-- Category Selector -->
      <div class="category-section">
        <div class="category-label">Cat√©gorie</div>
        <div class="category-scroll" id="category-list">
          <div class="category-chip" onclick="selectCategory(this, 'üçΩÔ∏è Alimentation', '#ff453a')">
            <span class="category-icon">üçΩÔ∏è</span>
            <span class="category-name">Alim</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üöó Transport', '#0a84ff')">
            <span class="category-icon">üöó</span>
            <span class="category-name">Trans</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üè† Logement', '#bf5af2')">
            <span class="category-icon">üè†</span>
            <span class="category-name">Logt</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, '‚öïÔ∏è Sant√©', '#30d158')">
            <span class="category-icon">‚öïÔ∏è</span>
            <span class="category-name">Sant√©</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üéÆ Loisirs', '#ff9f0a')">
            <span class="category-icon">üéÆ</span>
            <span class="category-name">Loisirs</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üõçÔ∏è Shopping', '#ff375f')">
            <span class="category-icon">üõçÔ∏è</span>
            <span class="category-name">Shop</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üë∂ Enfants', '#64d2ff')">
            <span class="category-icon">üë∂</span>
            <span class="category-name">Enfants</span>
          </div>
          <div class="category-chip" onclick="selectCategory(this, 'üì¶ Autre', '#8e8e93')">
            <span class="category-icon">üì¶</span>
            <span class="category-name">Autre</span>
          </div>
        </div>
      </div>

      <!-- ERGONOMIC NUMBER PAD -->
      <div class="pad-container">
        <div class="pad-row">
          <button class="num-key" onclick="pressKey('1')">1</button>
          <button class="num-key" onclick="pressKey('2')">2</button>
          <button class="num-key" onclick="pressKey('3')">3</button>
        </div>
        <div class="pad-row">
          <button class="num-key" onclick="pressKey('4')">4</button>
          <button class="num-key" onclick="pressKey('5')">5</button>
          <button class="num-key" onclick="pressKey('6')">6</button>
        </div>
        <div class="pad-row">
          <button class="num-key" onclick="pressKey('7')">7</button>
          <button class="num-key" onclick="pressKey('8')">8</button>
          <button class="num-key" onclick="pressKey('9')">9</button>
        </div>
        <div class="pad-row">
          <button class="num-key wide delete" onclick="pressKey('back')">‚å´</button>
          <button class="num-key zero" onclick="pressKey('0')">0</button>
          <button class="num-key action" onclick="pressKey('add')">‚úì</button>
        </div>
      </div>

    </div>

    <!-- STATS ROW -->
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-value neutral" id="stat-budget">0</div>
        <div class="stat-label">Budget/j</div>
      </div>
      <div class="stat-item">
        <div class="stat-value negative" id="stat-spent">0</div>
        <div class="stat-label">D√©pens√©</div>
      </div>
      <div class="stat-item">
        <div class="stat-value positive" id="stat-remaining">0</div>
        <div class="stat-label">Restant</div>
      </div>
      <div class="stat-item">
        <div class="stat-value neutral" id="stat-days">0</div>
        <div class="stat-label">Jours</div>
      </div>
    </div>

    <!-- CALENDAR -->
    <div class="calendar-card">
      <div class="calendar-header">
        <div class="calendar-title" id="cal-month">Octobre 2024</div>
        <div class="calendar-nav">
          <button class="calendar-btn" onclick="changeMonth(-1)">‚Äπ</button>
          <button class="calendar-btn" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <!-- RECENT TRANSACTIONS -->
    <div class="recent-card">
      <div class="recent-header">
        <span class="recent-title">Aujourd'hui</span>
        <span class="recent-action" onclick="showAll()">Tout voir</span>
      </div>
      <div id="recent-list">
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <div>Aucune d√©pense</div>
        </div>
      </div>
    </div>

  </main>

  <!-- TAB BAR -->
  <nav class="tab-bar">
    <div class="tab-item active" onclick="switchTab('home', this)">
      <span class="tab-icon">üè†</span>
      <span class="tab-label">Accueil</span>
    </div>
    <div class="tab-item" onclick="switchTab('stats', this)">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">Stats</span>
    </div>
    <div class="tab-item" onclick="openSettings()">
      <span class="tab-icon">‚öôÔ∏è</span>
      <span class="tab-label">R√©glages</span>
    </div>
  </nav>

</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settings-modal" onclick="closeSettings(event)">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Configuration</div>
    
    <div class="input-group">
      <label class="input-label">Revenu mensuel (DT)</label>
      <input type="number" class="ios-input" id="setting-income" placeholder="2000">
    </div>
    
    <div class="input-group">
      <label class="input-label">√âpargne mensuelle (DT)</label>
      <input type="number" class="ios-input" id="setting-savings" placeholder="500">
    </div>
    
    <button class="modal-btn" onclick="saveSettings()">Sauvegarder</button>
    <button class="modal-btn secondary" onclick="closeSettings()">Annuler</button>
  </div>
</div>

<script>
class BudgetApp {
  constructor() {
    this.amount = '0';
    this.selectedCategory = null;
    this.selectedCategoryEl = null;
    this.selectedColor = null;
    this.description = '';
    this.selectedDay = new Date().getDate();
    this.currentMonth = new Date().getMonth();
    this.currentYear = new Date().getFullYear();
    
    this.data = this.loadData();
    this.init();
  }

  loadData() {
    const saved = localStorage.getItem('budget_iphone16_v3');
    return saved ? JSON.parse(saved) : {
      income: 0,
      savings: 0,
      expenses: {},
      categories: {
        'üçΩÔ∏è Alimentation': { color: '#ff453a', icon: 'üçΩÔ∏è' },
        'üöó Transport': { color: '#0a84ff', icon: 'üöó' },
        'üè† Logement': { color: '#bf5af2', icon: 'üè†' },
        '‚öïÔ∏è Sant√©': { color: '#30d158', icon: '‚öïÔ∏è' },
        'üéÆ Loisirs': { color: '#ff9f0a', icon: 'üéÆ' },
        'üõçÔ∏è Shopping': { color: '#ff375f', icon: 'üõçÔ∏è' },
        'üë∂ Enfants': { color: '#64d2ff', icon: 'üë∂' },
        'üì¶ Autre': { color: '#8e8e93', icon: 'üì¶' }
      }
    };
  }

  save() {
    localStorage.setItem('budget_iphone16_v3', JSON.stringify(this.data));
  }

  init() {
    this.updateHeaderDate();
    this.renderCalendar();
    this.updateUI();
    
    if (this.data.income === 0) {
      setTimeout(() => this.openSettings(), 600);
    }

    // Focus description input on load for quick entry
    document.getElementById('desc-input').addEventListener('focus', () => {
      this.haptic('light');
    });
  }

  updateHeaderDate() {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    document.getElementById('header-date').textContent = 
      new Date().toLocaleDateString('fr-FR', options);
  }

  getMonthKey() {
    return `${this.currentYear}-${String(this.currentMonth + 1).padStart(2, '0')}`;
  }

  getDailyBudget() {
    const daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
    return ((this.data.income - this.data.savings) / daysInMonth) || 0;
  }

  getMonthExpenses() {
    const monthData = this.data.expenses[this.getMonthKey()] || {};
    return Object.values(monthData).flat().reduce((sum, e) => sum + e.amount, 0);
  }

  getDayExpenses(day) {
    const monthData = this.data.expenses[this.getMonthKey()] || {};
    return monthData[day] || [];
  }

  pressKey(key) {
    this.haptic('light');
    
    if (key === 'back') {
      if (this.amount.length > 1) {
        this.amount = this.amount.slice(0, -1);
      } else {
        this.amount = '0';
      }
    } else if (key === 'add') {
      this.addExpense();
      return;
    } else {
      if (this.amount === '0') {
        this.amount = key;
      } else if (this.amount.length < 6) {
        this.amount += key;
      }
    }
    
    this.updateDisplay();
    
    // Visual feedback
    const btn = event.target;
    btn.classList.add('key-anim');
    setTimeout(() => btn.classList.remove('key-anim'), 150);
  }

  updateDisplay() {
    const num = parseInt(this.amount);
    document.getElementById('display-amount').textContent = 
      num.toLocaleString('fr-FR');
  }

  setDescription(desc) {
    this.haptic('light');
    const input = document.getElementById('desc-input');
    input.value = desc;
    this.description = desc;
    
    // Update chips UI
    document.querySelectorAll('.desc-chip').forEach(c => c.classList.remove('selected'));
    event.target.classList.add('selected');
  }

  selectCategory(el, category, color) {
    this.haptic('light');
    
    if (this.selectedCategoryEl) {
      this.selectedCategoryEl.classList.remove('selected');
    }
    
    el.classList.add('selected');
    this.selectedCategoryEl = el;
    this.selectedCategory = category;
    this.selectedColor = color;
  }

  addExpense() {
    const amount = parseInt(this.amount);
    
    if (amount === 0) {
      this.haptic('error');
      this.shakeDisplay();
      return;
    }
    
    if (!this.selectedCategory) {
      this.haptic('error');
      // Auto-select first category if none selected
      const firstCat = document.querySelector('.category-chip');
      if (firstCat) firstCat.click();
      return;
    }

    const desc = document.getElementById('desc-input').value || this.selectedCategory;
    
    const monthKey = this.getMonthKey();
    if (!this.data.expenses[monthKey]) this.data.expenses[monthKey] = {};
    if (!this.data.expenses[monthKey][this.selectedDay]) {
      this.data.expenses[monthKey][this.selectedDay] = [];
    }

    this.data.expenses[monthKey][this.selectedDay].push({
      amount: amount,
      category: this.selectedCategory,
      description: desc,
      color: this.selectedColor,
      timestamp: new Date().toISOString()
    });

    this.save();
    this.haptic('success');
    
    // Reset form
    this.amount = '0';
    this.updateDisplay();
    document.getElementById('desc-input').value = '';
    this.description = '';
    document.querySelectorAll('.desc-chip').forEach(c => c.classList.remove('selected'));
    
    // Keep category selected for rapid entry
    
    this.showNotification(`-${amount} DT`);
    this.updateUI();
    this.renderCalendar();
  }

  shakeDisplay() {
    const display = document.querySelector('.amount-display');
    display.style.animation = 'shake 0.5s';
    setTimeout(() => display.style.animation = '', 500);
  }

  deleteExpense(day, index) {
    if (confirm('Supprimer cette d√©pense ?')) {
      const monthKey = this.getMonthKey();
      this.data.expenses[monthKey][day].splice(index, 1);
      if (this.data.expenses[monthKey][day].length === 0) {
        delete this.data.expenses[monthKey][day];
      }
      this.save();
      this.haptic('light');
      this.updateUI();
      this.renderCalendar();
    }
  }

  selectDay(day) {
    this.haptic('light');
    this.selectedDay = day;
    this.renderCalendar();
    this.renderRecentList();
  }

  changeMonth(delta) {
    this.currentMonth += delta;
    if (this.currentMonth > 11) {
      this.currentMonth = 0;
      this.currentYear++;
    } else if (this.currentMonth < 0) {
      this.currentMonth = 11;
      this.currentYear--;
    }
    this.renderCalendar();
  }

  renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                   'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    
    document.getElementById('cal-month').textContent = 
      `${months[this.currentMonth]} ${this.currentYear}`;
    
    const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    let html = days.map(d => `<div class="cal-day-header">${d}</div>`).join('');
    
    const firstDay = new Date(this.currentYear, this.currentMonth, 1).getDay();
    const daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
    
    for (let i = 0; i < firstDay; i++) html += '<div></div>';
    
    const today = new Date();
    const isCurrentMonth = today.getMonth() === this.currentMonth && 
                          today.getFullYear() === this.currentYear;
    const todayNum = today.getDate();
    const dailyBudget = this.getDailyBudget();
    
    for (let i = 1; i <= daysInMonth; i++) {
      const dayExp = this.getDayExpenses(i);
      const total = dayExp.reduce((s, e) => s + e.amount, 0);
      const isToday = isCurrentMonth && i === todayNum;
      const isSelected = i === this.selectedDay;
      
      let dot = '';
      if (total > 0) {
        const color = total <= dailyBudget ? 'var(--ios-green)' : 
                     total <= dailyBudget * 1.3 ? 'var(--ios-orange)' : 'var(--ios-red)';
        dot = `<div class="cal-dot" style="background: ${color}"></div>`;
      }
      
      html += `
        <div class="cal-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''} ${total > 0 ? 'has-data' : ''}" 
             onclick="app.selectDay(${i})">
          ${i}
          ${dot}
        </div>
      `;
    }
    
    grid.innerHTML = html;
  }

  updateUI() {
    const daily = this.getDailyBudget();
    const spent = this.getMonthExpenses();
    const remaining = this.data.income - this.data.savings - spent;
    const daysLeft = new Date(this.currentYear, this.currentMonth + 1, 0).getDate() - 
                     (this.currentMonth === new Date().getMonth() ? new Date().getDate() : 0);
    
    document.getElementById('stat-budget').textContent = Math.round(daily);
    document.getElementById('stat-spent').textContent = spent;
    document.getElementById('stat-remaining').textContent = remaining;
    document.getElementById('stat-days').textContent = daysLeft;
    
    this.renderRecentList();
  }

  renderRecentList() {
    const container = document.getElementById('recent-list');
    const list = this.getDayExpenses(this.selectedDay);
    
    if (list.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üìù</div>
          <div>Aucune d√©pense ce jour</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = list.map((e, i) => `
      <div class="recent-item" onclick="app.deleteExpense(${this.selectedDay}, ${i})">
        <div class="recent-icon" style="background: ${e.color}20; color: ${e.color};">
          ${this.data.categories[e.category]?.icon || 'üí∞'}
        </div>
        <div class="recent-info">
          <div class="recent-desc">${e.description || e.category}</div>
          <div class="recent-meta">${e.category} ‚Ä¢ ${new Date(e.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}</div>
        </div>
        <div class="recent-amount">-${e.amount}</div>
      </div>
    `).join('');
  }

  openSettings() {
    document.getElementById('setting-income').value = this.data.income || '';
    document.getElementById('setting-savings').value = this.data.savings || '';
    document.getElementById('settings-modal').classList.add('active');
  }

  closeSettings(e) {
    if (!e || e.target.id === 'settings-modal') {
      document.getElementById('settings-modal').classList.remove('active');
    }
  }

  saveSettings() {
    const income = parseFloat(document.getElementById('setting-income').value);
    const savings = parseFloat(document.getElementById('setting-savings').value);
    
    if (income > 0) {
      this.data.income = income;
      this.data.savings = savings || 0;
      this.save();
      this.updateUI();
      this.closeSettings();
      this.showNotification('Configuration sauvegard√©e ‚úì');
    }
  }

  switchTab(tab, el) {
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
  }

  showNotification(msg) {
    const div = document.createElement('div');
    div.style.cssText = `
      position: fixed;
      top: calc(var(--safe-top) + 50px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--ios-green);
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 16px;
      z-index: 3000;
      animation: fadeIn 0.3s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2000);
  }

  haptic(type) {
    if (navigator.vibrate) {
      switch(type) {
        case 'light': navigator.vibrate(5); break;
        case 'success': navigator.vibrate([10, 30, 10]); break;
        case 'error': navigator.vibrate([40, 100, 40]); break;
      }
    }
  }
}

const app = new BudgetApp();

// Global functions
function pressKey(k) { app.pressKey(k); }
function setDescription(d) { app.setDescription(d); }
function selectCategory(el, c, col) { app.selectCategory(el, c, col); }
function changeMonth(d) { app.changeMonth(d); }
function switchTab(t, el) { app.switchTab(t, el); }
function openSettings() { app.openSettings(); }
function closeSettings(e) { app.closeSettings(e); }
function saveSettings() { app.saveSettings(); }
function showAll() { alert('Vue compl√®te - √† venir'); }

// Add shake animation
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }
`;
document.head.appendChild(style);

// Prevent double tap zoom
let lastTouchEnd = 0;
document.addEventListener('touchend', (e) => {
  const now = Date.now();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Keyboard support for testing on desktop
document.addEventListener('keydown', (e) => {
  if (e.key >= '0' && e.key <= '9') pressKey(e.key);
  if (e.key === 'Backspace') pressKey('back');
  if (e.key === 'Enter') pressKey('add');
});
</script>

</body>
</html>
